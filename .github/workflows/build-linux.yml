name: Build Linux App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 24
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '24'
          cache: 'maven'

      # 1. Decode Secret (Linux uses 'base64 -d')
      - name: Create Firebase Key
        run: echo "${{ secrets.FIREBASE_KEY_BASE64 }}" | base64 -d > serviceAccountKey.json

      # 2. Build JAR & Libs
      - name: Build with Maven
        run: |
          mvn clean install
          mvn dependency:copy-dependencies -DoutputDirectory=target/lib

      # 3. Setup Staging (Standard Bash commands)
      - name: Prepare Staging
        run: |
          mkdir -p target/staging
          cp target/inventory_MS-1.0-SNAPSHOT.jar target/staging/
          cp -r target/lib target/staging/

      # 4. Package App Image
      # Note: We use ${PWD} for absolute paths in Linux
      - name: Package Linux App
        run: |
          jpackage \
            --type app-image \
            --input "${PWD}/target/staging" \
            --dest "${PWD}/target/dist" \
            --name "InventorySystem" \
            --main-jar "inventory_MS-1.0-SNAPSHOT.jar" \
            --main-class "login.Launcher" \
            --verbose

      # 5. Inject Key & Create Tarball
      - name: Finalize Package
        run: |
          # Find the directory jpackage created (avoids naming errors)
          APP_DIR=$(find target/dist -maxdepth 1 -type d -name "InventorySystem" | head -n 1)
          
          if [ -z "$APP_DIR" ]; then
            echo "CRITICAL: App directory not found!"
            exit 1
          fi
          
          echo "Found app at: $APP_DIR"
          
          # Inject the key inside the app folder
          cp serviceAccountKey.json "$APP_DIR/"
          
          # Rename folder to avoid confusion (InventorySystem-Linux)
          mv "$APP_DIR" target/dist/InventorySystem-Linux
          
          # Compress into tar.gz (Arch Linux preferred format)
          cd target/dist
          tar -czvf InventorySystem-Linux.tar.gz InventorySystem-Linux

      # 6. Upload to Release (Appends to existing tag)
      - name: Publish to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: target/dist/InventorySystem-Linux.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}